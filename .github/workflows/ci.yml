name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Validate VERSION and README alignment
        shell: bash
        run: |
          if [[ ! -f VERSION ]]; then
            echo "VERSION file is missing." >&2
            exit 1
          fi

          VERSION_VALUE="$(tr -d '[:space:]' < VERSION)"
          if [[ ! "${VERSION_VALUE}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "VERSION must be MAJOR.MINOR.PATCH. Got: ${VERSION_VALUE}" >&2
            exit 1
          fi

          if ! grep -q "v${VERSION_VALUE}" README.md; then
            echo "README.md must include the current version tag v${VERSION_VALUE}." >&2
            exit 1
          fi

      - name: Validate schema tool
        shell: bash
        run: |
          python3 --version
          python3 opencode/tools/validate-schema.py --help
          python3 scripts/export-copilot-agents.py --source-agents opencode/agents --target-dir ./.tmp-copilot --strict --dry-run

      - name: Validate shell installers
        shell: bash
        run: |
          bash -n scripts/install.sh
          bash -n scripts/install-copilot.sh
          bash -n scripts/bootstrap-install.sh
          bash -n scripts/bootstrap-install-copilot.sh
          bash scripts/install.sh --target ./.tmp-opencode-install --dry-run
          bash scripts/install-copilot.sh --target ./.tmp-copilot-install --dry-run

  validate-powershell:
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Validate PowerShell installers
        shell: pwsh
        run: |
          [void](Get-Command -Name ./scripts/install.ps1)
          [void](Get-Command -Name ./scripts/install-copilot.ps1)
          [void](Get-Command -Name ./scripts/bootstrap-install.ps1)
          [void](Get-Command -Name ./scripts/bootstrap-install-copilot.ps1)
          pwsh -NoProfile -File scripts/install.ps1 -Target .\.tmp-opencode-install -DryRun
          pwsh -NoProfile -File scripts/install-copilot.ps1 -Target .\.tmp-copilot-install -DryRun
